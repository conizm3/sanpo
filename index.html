<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Instant Talk AI - è‹±ä¼šè©±ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼</title>
    
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª (ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f1f5f9; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // â˜…é‡è¦â˜… ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        // ==========================================
        const API_KEY = "AIzaSyBrIn_1OkqmrarHd7KuIPPymJ81aI5aFHE"; // ä¾‹: "AIzaSy..."
        
        const AI_MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const AI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent?key=${API_KEY}`;
        const MAX_RETRIES = 3;

        // --- ã‚¢ã‚¤ã‚³ãƒ³å®šç¾© (ä¿®æ­£ç‰ˆ: åå‰ã®è¡çªã‚’é¿ã‘ã‚‹ãŸã‚SvgWrapperã«å¤‰æ›´) ---
        const SvgWrapper = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        
        // å„ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const Mic = (p) => <SvgWrapper {...p}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="22"/></SvgWrapper>;
        const MicOff = (p) => <SvgWrapper {...p}><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 6 0V9"/><path d="M15 2a3 3 0 0 0-3-3v7M5 12a7 7 0 0 0 10.87 5.76"/><line x1="12" y1="19" x2="12" y2="22"/></SvgWrapper>;
        const Send = (p) => <SvgWrapper {...p}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></SvgWrapper>;
        const Play = (p) => <SvgWrapper {...p}><polygon points="5 3 19 12 5 21 5 3"/></SvgWrapper>;
        const RotateCcw = (p) => <SvgWrapper {...p}><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></SvgWrapper>;
        const MessageSquare = (p) => <SvgWrapper {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></SvgWrapper>;
        const CheckCircle = (p) => <SvgWrapper {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></SvgWrapper>;
        const Volume2 = (p) => <SvgWrapper {...p}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 10.46a4.24 4.24 0 0 0 0 4.96"/></SvgWrapper>;
        const X = (p) => <SvgWrapper {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></SvgWrapper>;
        const Edit3 = (p) => <SvgWrapper {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></SvgWrapper>;
        const Lightbulb = (p) => <SvgWrapper {...p}><path d="M15 14c.2-1 .2-2 0-3 0-1 0-2 .1-3.2A4.2 4.2 0 0 0 9 3"/><path d="M10 20a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2Z"/><path d="M12 14a2 2 0 0 0-2 2v2h4v-2a2 2 0 0 0-2-2z"/></SvgWrapper>;
        const ArrowRight = (p) => <SvgWrapper {...p}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></SvgWrapper>;
        const BookOpen = (p) => <SvgWrapper {...p}><path d="M2 17a5 5 0 0 1 5-5 5 5 0 0 1 5 5v5a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z"/><path d="M12 17a5 5 0 0 1 5-5 5 5 0 0 1 5 5v5a2 2 0 0 1-2 2h-6a2 2 0 0 1-2-2Z"/><path d="M12 17V5h5"/></SvgWrapper>;
        const GraduationCap = (p) => <SvgWrapper {...p}><path d="M21.42 10.922a1 1 0 0 0-.01-1.848L12.02 5.5a1 1 0 0 0-1.82 0L2.59 9.074a1 1 0 0 0-.01 1.848l8.528 4.265a1 1 0 0 0 .93 0l8.528-4.265Z"/><path d="M12 3v13"/><path d="M22 17.5V20a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-2.5"/></SvgWrapper>;
        const Home = (p) => <SvgWrapper {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></SvgWrapper>;
        const LogOut = (p) => <SvgWrapper {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></SvgWrapper>;
        const Loader = (p) => <SvgWrapper {...p}><path d="M12 2v4"/><path d="m16.2 7.8 2.5-2.5"/><path d="M18 12h4"/><path d="m16.2 16.2 2.5 2.5"/><path d="M12 18v4"/><path d="m7.8 16.2-2.5 2.5"/><path d="M6 12H2"/><path d="m7.8 7.8-2.5-2.5"/></SvgWrapper>;
        const Coffee = (p) => <SvgWrapper {...p}><path d="M10 2v4a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2"/><path d="M21 6h-6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2z"/><path d="M8 12h8"/></SvgWrapper>;
        const Hotel = (p) => <SvgWrapper {...p}><path d="M6 21v-8a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8"/><path d="M2 10h20"/><path d="M12 10V3"/><path d="M8 6h.01"/><path d="M16 6h.01"/></SvgWrapper>;
        const Plane = (p) => <SvgWrapper {...p}><path d="M17.882 3.122a2 2 0 0 0-2.828 0l-1.414 1.414a2 2 0 0 0 0 2.828L18.67 11.5 13 17h-2L7.33 13.33 3.12 17.54l-1.41 1.41a2 2 0 0 0 0 2.83L6.87 23.88a2 2 0 0 0 2.82 0l4.21-4.21 4.75 4.75a2 2 0 0 0 2.82 0L24 16.92 19.54 12.46l4.21-4.21a2 2 0 0 0 0-2.82l-3.08-3.08z"/></SvgWrapper>;
        const Briefcase = (p) => <SvgWrapper {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></SvgWrapper>;
        const Sparkles = (p) => <SvgWrapper {...p}><path d="M18 6L14 10l-4 4 4 4 4-4 4-4L18 6z"/><path d="M2 13h4"/><path d="M10 3v4"/><path d="M18 10h4"/><path d="M6 17v4"/></SvgWrapper>;
        const Star = (p) => <SvgWrapper {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></SvgWrapper>;

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        const speak = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                window.speechSynthesis.speak(utterance);
                return new Promise(resolve => {
                    utterance.onend = resolve;
                    utterance.onerror = resolve;
                });
            } else {
                return Promise.resolve();
            }
        };

        // ãƒ‡ãƒ¼ã‚¿å®šç¾©
        const HARDCODED_SCRIPTS = {
            restaurant: [
                { role: 'ai', en: 'Good evening, welcome to The Grand Bistro. Do you have a reservation with us tonight?', ja: 'ã“ã‚“ã°ã‚“ã¯ã€ã‚¶ãƒ»ã‚°ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ“ã‚¹ãƒˆãƒ­ã¸ã‚ˆã†ã“ãã€‚ä»Šå¤œã¯ã”äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ' },
                { role: 'user', en: 'Yes, I have a reservation under the name Smith.', ja: 'ã¯ã„ã€ã‚¹ãƒŸã‚¹ã¨ã„ã†åå‰ã§äºˆç´„ã—ã¦ã„ã¾ã™ã€‚' },
                { role: 'ai', en: 'Ah, yes, Mr. Smith. A table for two right this way. May I get you started with some drinks?', ja: 'ãˆãˆã€ã‚¹ãƒŸã‚¹æ§˜ã§ã™ã­ã€‚ã“ã¡ã‚‰ã¸ã©ã†ãã€2åæ§˜ã®ãŠå¸­ã§ã™ã€‚ã¾ãšãŠé£²ã¿ç‰©ã‹ã‚‰ã„ã‹ãŒã§ã™ã‹ï¼Ÿ' },
                { role: 'user', en: 'I\'ll take a glass of the house white wine, please.', ja: 'ãƒã‚¦ã‚¹ãƒ¯ã‚¤ãƒ³ã®ç™½ã‚’ã‚°ãƒ©ã‚¹ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚' },
                { role: 'ai', en: 'Excellent choice. And for you, madam?', ja: 'ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚å¥¥æ§˜ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿ' },
            ],
            hotel: [
                { role: 'ai', en: 'Good afternoon, welcome to the Stellar Hotel. How may I assist you with your check-in?', ja: 'ã“ã‚“ã«ã¡ã¯ã€ã‚¹ãƒ†ãƒ©ãƒ›ãƒ†ãƒ«ã¸ã‚ˆã†ã“ãã€‚ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã®ãŠæ‰‹ä¼ã„ã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚' },
                { role: 'user', en: 'I have a reservation under the name Tanaka.', ja: 'ã‚¿ãƒŠã‚«ã¨ã„ã†åå‰ã§äºˆç´„ã—ã¦ã„ã¾ã™ã€‚' },
                { role: 'ai', en: 'Thank you, Mr. Tanaka. Could I please see your passport and reservation confirmation?', ja: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ç”°ä¸­æ§˜ã€‚ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¨äºˆç´„ç¢ºèªæ›¸ã‚’æ‹è¦‹ã§ãã¾ã™ã‹ï¼Ÿ' },
                { role: 'user', en: 'Certainly, here they are.', ja: 'ã‚‚ã¡ã‚ã‚“ã§ã™ã€ã©ã†ãã€‚' },
                { role: 'ai', en: 'Thank you. Your room is 1405, on the 14th floor. Here is your key card. Enjoy your stay.', ja: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠéƒ¨å±‹ã¯14éšã®1405å·å®¤ã§ã™ã€‚ã“ã¡ã‚‰ãŒã‚­ãƒ¼ã‚«ãƒ¼ãƒ‰ã§ã™ã€‚ã”æ»åœ¨ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚' },
            ],
            airport: [
                { role: 'ai', en: 'Good morning. Where are you flying to today?', ja: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚æœ¬æ—¥ã¯ã©ã¡ã‚‰ã¸è¡Œã‹ã‚Œã¾ã™ã‹ï¼Ÿ' },
                { role: 'user', en: 'I\'m flying to London. Here is my passport and ticket.', ja: 'ãƒ­ãƒ³ãƒ‰ãƒ³ã¸è¡Œãã¾ã™ã€‚ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¨ãƒã‚±ãƒƒãƒˆã§ã™ã€‚' },
                { role: 'ai', en: 'Thank you. Do you have any check-in baggage?', ja: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠé ã‘ã«ãªã‚‹æ‰‹è·ç‰©ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ' },
                { role: 'user', en: 'Yes, just this one suitcase.', ja: 'ã¯ã„ã€ã“ã®ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹ä¸€ã¤ã ã‘ã§ã™ã€‚' },
                { role: 'ai', en: 'Please place it on the scale. Your flight is departing from Gate 35. Boarding will begin at 8:30 AM.', ja: 'ç§¤ã®ä¸Šã«ç½®ã„ã¦ãã ã•ã„ã€‚ã”æ­ä¹—ã®ä¾¿ã¯35ç•ªã‚²ãƒ¼ãƒˆã‹ã‚‰å‡ºç™ºã—ã¾ã™ã€‚æ­ä¹—é–‹å§‹ã¯åˆå‰8æ™‚30åˆ†ã§ã™ã€‚' },
            ],
            interview: [
                { role: 'ai', en: 'Thank you for coming in, Mr. Sato. Could you please start by telling us a little bit about yourself?', ja: 'ä½è—¤ã•ã‚“ã€ãŠè¶Šã—ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãšã€ã”è‡ªèº«ã«ã¤ã„ã¦å°‘ã—ãŠè©±ã—ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ' },
                { role: 'user', en: 'Certainly. I have been working as a software engineer for five years, specializing in web development.', ja: 'ã‚‚ã¡ã‚ã‚“ã§ã™ã€‚ç§ã¯ã‚¦ã‚§ãƒ–é–‹ç™ºã‚’å°‚é–€ã¨ã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦5å¹´é–“åƒã„ã¦ã„ã¾ã™ã€‚' },
                { role: 'ai', en: 'That is interesting. What primarily motivated you to apply for this position at our company?', ja: 'ãã‚Œã¯èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚ä¸»ã«å½“ç¤¾ã®ã“ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã«å¿œå‹Ÿã—ã‚ˆã†ã¨æ€ã£ãŸãã£ã‹ã‘ã¯ä½•ã§ã™ã‹ï¼Ÿ' },
                { role: 'user', en: 'I am highly impressed by your commitment to innovative green technology.', ja: 'è²´ç¤¾ã®é©æ–°çš„ãªã‚°ãƒªãƒ¼ãƒ³ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã¸ã®å–ã‚Šçµ„ã¿ã«éå¸¸ã«æ„ŸéŠ˜ã‚’å—ã‘ã¾ã—ãŸã€‚' },
                { role: 'ai', en: 'We appreciate that. Can you describe a challenging project you have managed and how you overcame it?', ja: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã‚ãªãŸãŒç®¡ç†ã—ãŸä¸­ã§ã€å›°é›£ã ã£ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã€ãã‚Œã‚’ã©ã®ã‚ˆã†ã«ä¹—ã‚Šè¶ŠãˆãŸã‹èª¬æ˜ã—ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ' },
            ],
        };

        const SCENARIOS = [
            { id: 'restaurant', icon: Coffee, title: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', prompt: 'ã‚ãªãŸã¯é«˜ç´šãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚ãŠã™ã™ã‚ã‚’ç´¹ä»‹ã—ã€æ³¨æ–‡ã‚’ã¨ã£ã¦ãã ã•ã„ã€‚ã“ã®ä¼šè©±ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–™ç†ã¨é£²ã¿ç‰©ã‚’æ³¨æ–‡ã™ã‚‹ã“ã¨ã§ã™ã€‚' },
            { id: 'hotel', icon: Hotel, title: 'ãƒ›ãƒ†ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³', prompt: 'ã‚ãªãŸã¯ãƒ›ãƒ†ãƒ«ã®ãƒ•ãƒ­ãƒ³ãƒˆä¿‚ã§ã™ã€‚äºˆç´„ç¢ºèªã¨ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ‰‹ç¶šãã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ã“ã®ä¼šè©±ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’å®Œäº†ã—ã€éƒ¨å±‹ã®æƒ…å ±ã‚’å¾—ã‚‹ã“ã¨ã§ã™ã€‚' },
            { id: 'airport', icon: Plane, title: 'ç©ºæ¸¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼', prompt: 'ã‚ãªãŸã¯å›½éš›ç·šã®èˆªç©ºä¼šç¤¾ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è·å“¡ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ­ä¹—æ‰‹ç¶šãã¨è·ç‰©é ã‹ã‚Šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ã“ã®ä¼šè©±ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­ä¹—æ‰‹ç¶šãã‚’å®Œäº†ã™ã‚‹ã“ã¨ã§ã™ã€‚' },
            { id: 'interview', icon: Briefcase, title: 'è‹±èªé¢æ¥', prompt: 'ã‚ãªãŸã¯ITä¼æ¥­ã®é¢æ¥å®˜ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµŒé¨“ã¨ã‚¹ã‚­ãƒ«ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„ã€‚ã“ã®ä¼šè©±ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªå·±ç´¹ä»‹ã¨è·å‹™çµŒé¨“ã‚’è‹±èªã§èª¬æ˜ã™ã‚‹ã“ã¨ã§ã™ã€‚' },
            { id: 'custom', icon: Sparkles, title: 'è‡ªç”±è¨­å®š', prompt: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸçŠ¶æ³ã§ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚’è¡Œã„ã¾ã™ã€‚' },
        ];

        async function fetchWithRetry(url, payload) {
            let attempt = 0;
            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(url, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error.message);
                    if (attempt < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                        attempt++;
                    } else throw new Error("Failed to connect to API.");
                }
            }
        }

        const App = () => {
            const [screen, setScreen] = useState('home'); 
            const [scenario, setScenario] = useState(null);
            const [customSettings, setCustomSettings] = useState({ where: '', who: '', what: '' });
            const [messages, setMessages] = useState([]);
            const [scriptData, setScriptData] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [micStatus, setMicStatus] = useState('ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦è©±ã™'); 
            const [showSubtitles, setShowSubtitles] = useState(true);
            const [showScriptModal, setShowScriptModal] = useState(false);
            const [feedback, setFeedback] = useState(null);
            const [isLoading, setIsLoading] = useState(false); 

            const messagesEndRef = useRef(null);
            const recognition = useRef(null);
            const isSpeakingRef = useRef(isSpeaking);

            useEffect(() => { isSpeakingRef.current = isSpeaking; }, [isSpeaking]);

            const goToHome = () => {
                if ('speechSynthesis' in window) window.speechSynthesis.cancel();
                if (recognition.current) recognition.current.abort();
                setIsLoading(false); setIsSpeaking(false); setScenario(null); setScriptData([]); setMessages([]);
                setCustomSettings({ where: '', who: '', what: '' }); setMicStatus('ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦è©±ã™'); setScreen('home');
            };

            const handleSpeak = async (text) => {
                setIsSpeaking(true);
                await speak(text);
                setIsSpeaking(false);
            };

            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognition.current = new SpeechRecognition();
                    recognition.current.continuous = false;
                    recognition.current.lang = 'en-US'; 
                    recognition.current.interimResults = false;
                    
                    let finalTranscript = '';
                    recognition.current.onstart = () => {
                        setMicStatus('ğŸ”´ èãå–ã‚Šä¸­...'); setIsRecording(true); finalTranscript = '';
                    };
                    recognition.current.onresult = (event) => {
                        finalTranscript = Array.from(event.results).filter(r => r.isFinal).map(r => r[0].transcript).join('');
                        if (finalTranscript) setInputText(finalTranscript);
                    };
                    recognition.current.onend = () => {
                        setIsRecording(false);
                        setMicStatus(finalTranscript ? 'âœ… éŸ³å£°å…¥åŠ›å®Œäº†' : 'ğŸ”‡ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                    };
                    recognition.current.onerror = (event) => {
                        console.error("Mic Error:", event.error);
                        setIsRecording(false);
                        if (event.error === 'not-allowed') setMicStatus('âŒ ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
                        else setMicStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    };
                } else {
                    setMicStatus('ãƒã‚¤ã‚¯éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™');
                }
                return () => { if (recognition.current) recognition.current.abort(); };
            }, []);

            useEffect(() => { if (screen === 'chat') messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, screen]);

            const handleScenarioSelect = async (selected) => {
                if (isLoading || isSpeakingRef.current) return; 
                setScenario(selected); setScriptData([]);
                if (selected.id === 'custom') { setScreen('custom_setup'); return; } 
                const script = HARDCODED_SCRIPTS[selected.id];
                if (script) { setScriptData(script); setScreen('script'); } 
                else { alert("ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼"); goToHome(); }
            };

            const handleCustomSubmit = async () => {
                if (!customSettings.where || !customSettings.what || isLoading) return;
                const who = customSettings.who || 'AI';
                const customPrompt = `å ´æ‰€: ${customSettings.where}, ç›¸æ‰‹: ${who}, ç›®çš„: ${customSettings.what}ã€‚ã‚ãªãŸã¯${who}ã§ã™ã€‚`;
                const customScenario = SCENARIOS.find(s => s.id === 'custom');
                setScenario(prev => ({ ...customScenario, title: customSettings.what || 'è‡ªç”±è¨­å®š', prompt: customPrompt }));
                setIsLoading(true); 
                try {
                    const userQuery = "ã“ã®ã‚·ãƒŠãƒªã‚ªã®å°å…¥ã¨ã—ã¦ã€AIã®æœ€åˆã®ç™ºè¨€ã‹ã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¬¡ã®å¿œç­”ã‚’ã™ã‚‹ã¾ã§ã®4å¾€å¾©ã®ä¼šè©±ã‚’ã€è‹±èªã¨æ—¥æœ¬èªã§ä½œæˆã€‚";
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: customPrompt + " å›ç­”ã¯JSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦ãã ã•ã„ã€‚" }] },
                        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "role": { "type": "STRING", enum: ["ai", "user"] }, "en": { "type": "STRING" }, "ja": { "type": "STRING" } }, required: ["role", "en", "ja"] } } }
                    };
                    const result = await fetchWithRetry(AI_API_URL, payload);
                    const script = JSON.parse(result.candidates[0].content.parts[0].text);
                    setScriptData(script); setScreen('script');
                } catch (error) { console.error(error); alert("å°æœ¬ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ"); } 
                finally { setIsLoading(false); }
            };

            const startChat = () => {
                if(isSpeakingRef.current) return;
                setScreen('chat'); setMessages([]); setFeedback(null); setShowScriptModal(false);
                const firstLine = scriptData[0]?.en || "Hello!";
                setTimeout(() => {
                    setMessages([{ role: 'ai', text: firstLine }]);
                    handleSpeak(firstLine);
                }, 500);
            };

            const handleSend = async (text) => {
                if (!text.trim() || isLoading || isSpeakingRef.current) return;
                const userMessage = { role: 'user', text };
                setMessages(prev => [...prev, userMessage]);
                setInputText(''); setMicStatus('ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦è©±ã™'); setIsLoading(true);
                try {
                    const chatHistory = [...messages, userMessage].map(m => ({ role: m.role === 'ai' ? 'model' : 'user', parts: [{ text: m.text }] }));
                    const payload = {
                        contents: chatHistory,
                        systemInstruction: { parts: [{ text: scenario.prompt + " æ¬¡ã®è‡ªç„¶ãªè‹±èªã®ã‚»ãƒªãƒ•ã‚’ä¸€è¡Œã§è¿”ã—ã¦ãã ã•ã„ã€‚" }] }
                    };
                    const result = await fetchWithRetry(AI_API_URL, payload);
                    const aiResponseText = result.candidates[0].content.parts[0].text.trim();
                    setMessages(prev => [...prev, { role: 'ai', text: aiResponseText }]);
                    await handleSpeak(aiResponseText);
                } catch (error) { console.error(error); } 
                finally { setIsLoading(false); }
            };

            const finishConversation = async () => {
                if (isLoading) return;
                if(messages.filter(m => m.role === 'user').length < 1) { alert("ä¼šè©±ãŒå°‘ãªã™ãã¾ã™"); return; }
                setIsLoading(true);
                try {
                    const conversationText = messages.map(m => `${m.role === 'user' ? 'User' : 'AI'}: ${m.text}`).join('\n');
                    const payload = {
                        contents: [{ parts: [{ text: `ä»¥ä¸‹ã®ä¼šè©±è¨˜éŒ²ã‚’åˆ†æã—ã€Userã®è‹±èªåŠ›ã«å¯¾ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆã€‚\n${conversationText}` }] }],
                        systemInstruction: { 
                            parts: [{ text: "ã‚ãªãŸã¯ãƒ—ãƒ­ã®è‹±èªã‚³ãƒ¼ãƒã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã¯éŸ³å£°èªè­˜ã«ã‚ˆã‚‹ã‚‚ã®ãªã®ã§ã€ä»¥ä¸‹ã®ã€Œå½¢å¼çš„ãªã‚¨ãƒ©ãƒ¼ã€ã«ã¤ã„ã¦ã¯çµ¶å¯¾ã«æŒ‡æ‘˜ã—ãªã„ã§ãã ã•ã„ã€‚\n\nã€ç¦æ­¢äº‹é …ã€‘\nãƒ»ã€Œæ–‡ã®æœ€åˆã‚„å›ºæœ‰åè©ã¯å¤§æ–‡å­—ã§å§‹ã‚ã‚‹ã¹ãã€ã¨ã„ã†æŒ‡æ‘˜\nãƒ»ã€ŒYes/Noã®å¾Œã«ã¯ã‚³ãƒ³ãƒã‚’ã¤ã‘ã‚‹ã¨è‡ªç„¶ã€ã¨ã„ã£ãŸå¥èª­ç‚¹ã«é–¢ã™ã‚‹æŒ‡æ‘˜\nãƒ»ãƒ”ãƒªã‚ªãƒ‰ã‚„ã‚¯ã‚¨ã‚¹ãƒãƒ§ãƒ³ãƒãƒ¼ã‚¯ã®æ¬ è½ã«é–¢ã™ã‚‹æŒ‡æ‘˜\n\nã“ã‚Œã‚‰ã¯éŸ³å£°èªè­˜ã®ä»•æ§˜ã¨ã—ã¦ç„¡è¦–ã—ã€ç´”ç²‹ãªã€Œèªå½™ã®é¸æŠã€ã‚„ã€Œæ–‡æ³•æ§‹é€ ï¼ˆèªé †ãªã©ï¼‰ã€ã®èª¤ã‚Šã®ã¿ã‚’è©•ä¾¡ã—ã¦ã€JSONã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚" }] 
                        },
                        generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { "score": { type: "INTEGER" }, "summary": { type: "STRING" }, "grammarPoints": { type: "ARRAY", items: { type: "OBJECT", properties: { "original": { type: "STRING" }, "corrected": { type: "STRING" }, "explanation": { type: "STRING" } } } }, "suggestedPhrases": { type: "ARRAY", items: { type: "STRING" } } } } }
                    };
                    const result = await fetchWithRetry(AI_API_URL, payload);
                    const feedbackResult = JSON.parse(result.candidates[0].content.parts[0].text);
                    setFeedback(feedbackResult); setScreen('feedback');
                } catch (error) { console.error(error); alert("åˆ†æå¤±æ•—: API Keyã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
                finally { setIsLoading(false); }
            };

            const toggleRecording = () => {
                if (!recognition.current) return;
                if (isRecording) recognition.current.stop();
                else { recognition.current.abort(); setInputText(''); recognition.current.start(); }
            };

            const handleQuit = () => {
                goToHome();
            };

            // --- UI Components ---
            const LoadingOverlay = () => (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
                    <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center animate-pulse">
                        <Loader size={48} className="text-indigo-600 mb-4" />
                        <p className="font-extrabold text-xl text-slate-700">AIãŒå‡¦ç†ä¸­...</p>
                    </div>
                </div>
            );

            const ScenarioIcon = ({ icon: Icon, size, className }) => <Icon size={size} className={className} />;

            // --- Screens ---
            if (screen === 'home') {
                return (
                    <div className="min-h-screen bg-slate-100 p-4 font-sans text-slate-800 flex flex-col items-center">
                        {isLoading && <LoadingOverlay />}
                        <header className="mb-10 text-center pt-8">
                            <h1 className="text-4xl font-extrabold text-indigo-700 mb-2">Instant Talk AI</h1>
                            <p className="text-slate-500 font-medium">AIãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã§ç¬é–“è‹±ä¼šè©±åŠ›ã‚’é›ãˆã‚‹</p>
                        </header>
                        <div className="max-w-xl w-full grid gap-6">
                            <button onClick={() => handleScenarioSelect(SCENARIOS.find(s => s.id === 'custom'))} disabled={isLoading || isSpeaking} className="flex items-center p-6 bg-gradient-to-r from-indigo-600 to-purple-700 text-white rounded-2xl shadow-xl hover:scale-[1.02] transition disabled:opacity-70">
                                <span className="mr-4 bg-white/20 p-3 rounded-full"><Sparkles size={32} /></span>
                                <div className='flex-1'><div className="font-extrabold text-xl">è‡ªç”±è¨­å®šã§å§‹ã‚ã‚‹ (AIç”Ÿæˆ)</div></div>
                                <ArrowRight className="ml-auto opacity-70" size={24} />
                            </button>
                            <div className="text-lg font-bold text-slate-600 border-b pb-2 mt-4">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚·ãƒŠãƒªã‚ª (å³æ™‚é–‹å§‹)</div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                {SCENARIOS.filter(s => s.id !== 'custom').map(s => (
                                    <button key={s.id} onClick={() => handleScenarioSelect(s)} disabled={isLoading || isSpeaking} className="flex flex-col items-center justify-center p-4 bg-white rounded-xl shadow-lg hover:scale-[1.03] transition h-40 disabled:opacity-70">
                                        <ScenarioIcon icon={s.icon} size={40} className="text-indigo-500 mb-3" />
                                        <div className="font-bold text-sm text-slate-700">{s.title}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'custom_setup') {
                return (
                    <div className="min-h-screen bg-slate-100 p-4 flex items-center justify-center">
                        {isLoading && <LoadingOverlay />}
                        <div className="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl">
                            <div className="flex justify-between mb-6"><h2 className="text-2xl font-bold text-indigo-700 flex items-center gap-2"><Edit3 />è¨­å®š</h2><button onClick={goToHome}><X /></button></div>
                            <div className="space-y-4">
                                <input type="text" placeholder="ã©ã“ã§ï¼Ÿ (ä¾‹: ç©ºæ¸¯)" className="w-full p-3 border rounded-xl" value={customSettings.where} onChange={e => setCustomSettings({...customSettings, where: e.target.value})} disabled={isLoading || isSpeaking}/>
                                <input type="text" placeholder="èª°ã¨ï¼Ÿ (ä¾‹: ä¿‚å“¡)" className="w-full p-3 border rounded-xl" value={customSettings.who} onChange={e => setCustomSettings({...customSettings, who: e.target.value})} disabled={isLoading || isSpeaking}/>
                                <textarea placeholder="ç›®çš„ (ä¾‹: ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ãŸã„)" className="w-full p-3 border rounded-xl h-24" value={customSettings.what} onChange={e => setCustomSettings({...customSettings, what: e.target.value})} disabled={isLoading || isSpeaking}/>
                            </div>
                            <button onClick={handleCustomSubmit} disabled={!customSettings.where || !customSettings.what || isLoading} className="w-full mt-6 py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2">{isLoading ? <Loader className="animate-spin"/> : 'ä½œæˆ'}</button>
                        </div>
                    </div>
                );
            }

            if (screen === 'script') {
                return (
                    <div className="min-h-screen bg-slate-100 p-4 flex flex-col">
                        {isLoading && <LoadingOverlay />}
                        <header className="mb-4 flex justify-between items-center"><button onClick={goToHome} className="text-slate-500 flex gap-1" disabled={isLoading || isSpeaking}><Home /> ãƒˆãƒƒãƒ—</button><h2 className="text-xl font-bold text-indigo-800">å°æœ¬ç¢ºèª</h2><div className='w-10'></div></header>
                        <div className="flex-1 overflow-y-auto pb-24 space-y-4">
                            {scriptData.map((line, idx) => (
                                <div key={idx} className="p-4 bg-white rounded-xl shadow-sm">
                                    <div className="flex justify-between mb-1"><span className="text-xs font-bold bg-slate-200 px-2 py-1 rounded">{line.role}</span><button onClick={()=>handleSpeak(line.en)} disabled={isLoading || isSpeaking}><Volume2 size={18}/></button></div>
                                    <p className="font-bold text-lg">{line.en}</p><p className="text-sm text-slate-500">{line.ja}</p>
                                </div>
                            ))}
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t"><button onClick={startChat} disabled={isLoading || isSpeaking} className="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg flex justify-center gap-2"><GraduationCap /> å®Ÿè·µã‚¹ã‚¿ãƒ¼ãƒˆ</button></div>
                    </div>
                );
            }

            if (screen === 'chat') {
                return (
                    <div className="min-h-screen bg-slate-100 flex flex-col">
                        {isLoading && <LoadingOverlay />}
                        <header className="bg-white p-3 shadow flex justify-between sticky top-0 z-20">
                            <button onClick={handleQuit} disabled={isLoading}><LogOut className="text-slate-500"/></button>
                            <span className="font-bold text-slate-800">{scenario?.title}</span>
                            <div className="flex gap-2">
                                <button onClick={()=>setShowScriptModal(true)} className="text-indigo-600" disabled={isLoading}><BookOpen/></button>
                                <button onClick={finishConversation} className="bg-indigo-600 text-white px-3 py-1 rounded shadow text-sm" disabled={isLoading}>æ¡ç‚¹</button>
                            </div>
                        </header>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-32">
                            {messages.map((msg, i) => (
                                <div key={i} className={`flex gap-2 ${msg.role==='user'?'justify-end':'justify-start'}`}>
                                    {msg.role==='ai' && <div className="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600"><Sparkles size={16}/></div>}
                                    <div className={`max-w-[75%] p-3 rounded-2xl ${msg.role==='user'?'bg-indigo-600 text-white':'bg-white text-slate-800 shadow-sm'}`}>
                                        {msg.role==='ai' && !showSubtitles ? <div className="italic text-sm"><Volume2 size={14}/> éŸ³å£°ã®ã¿</div> : msg.text}
                                    </div>
                                    {msg.role==='ai' && <button onClick={()=>handleSpeak(msg.text)} className="text-slate-400"><Volume2 size={16}/></button>}
                                </div>
                            ))}
                            <div ref={messagesEndRef}/>
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t z-30 shadow-lg">
                            <div className="text-center text-xs text-slate-500 mb-2 h-4">{micStatus}</div>
                            <div className="flex gap-2">
                                <button onClick={toggleRecording} disabled={isLoading||isSpeaking} className={`w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg ${isRecording?'bg-red-500 animate-pulse':'bg-indigo-600'}`}>{isRecording?<MicOff/>:<Mic/>}</button>
                                <input type="text" value={inputText} onChange={e=>setInputText(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSend(inputText)} className="flex-1 border rounded-xl p-2" placeholder="ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›..." disabled={isLoading||isSpeaking}/>
                                <button onClick={()=>handleSend(inputText)} disabled={!inputText.trim()} className="p-3 bg-green-500 text-white rounded-xl shadow"><Send/></button>
                            </div>
                            <div className="text-center mt-2"><button onClick={()=>setShowSubtitles(!showSubtitles)} className="text-xs bg-slate-200 px-2 py-1 rounded text-slate-600">å­—å¹• {showSubtitles?'ON':'OFF'}</button></div>
                        </div>
                        {showScriptModal && <div className="absolute inset-0 bg-black/50 z-50 flex justify-end"><div className="w-3/4 bg-white h-full p-4 overflow-y-auto"><div className="flex justify-between mb-4"><h3 className="font-bold">å°æœ¬</h3><button onClick={()=>setShowScriptModal(false)}><X/></button></div>{scriptData.map((l,i)=><div key={i} className="mb-2 text-sm"><p className="font-bold">{l.role}</p><p>{l.en}</p></div>)}</div></div>}
                    </div>
                );
            }

            if (screen === 'feedback') {
                return (
                    <div className="min-h-screen bg-slate-50 p-4 flex flex-col">
                        <header className="text-center mb-6"><h2 className="text-2xl font-bold text-indigo-800">çµæœç™ºè¡¨</h2></header>
                        <div className="flex-1 overflow-y-auto pb-20 space-y-6">
                            <div className="bg-white p-6 rounded-2xl shadow-lg text-center border-t-4 border-indigo-600">
                                <div className="relative mb-4 w-32 h-32 mx-auto">
                                    <svg width="100%" height="100%" viewBox="0 0 150 150" className="rotate-[-90deg]">
                                        <circle cx="75" cy="75" r="70" fill="transparent" stroke="#e2e8f0" strokeWidth="10" />
                                        <circle cx="75" cy="75" r="70" fill="transparent" stroke="#4f46e5" strokeWidth="10" strokeDasharray={2 * Math.PI * 70} strokeDashoffset={2 * Math.PI * 70 * (1 - (feedback?.score || 0) / 100)} strokeLinecap="round" />
                                    </svg>
                                    <div className="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center">
                                        <p className="text-5xl font-black text-indigo-600">{feedback?.score}</p>
                                        <p className="text-lg font-bold text-slate-500 mt-1">ç‚¹</p>
                                    </div>
                                </div>
                                <p className="text-slate-600 mt-2">{feedback?.summary}</p>
                            </div>
                            {feedback?.grammarPoints?.length > 0 && (
                                <div className="bg-white p-4 rounded-xl shadow">
                                    <h3 className="font-bold text-pink-600 mb-2 flex gap-2"><Edit3/> æ”¹å–„ç‚¹</h3>
                                    {feedback.grammarPoints.map((pt,i)=>(
                                        <div key={i} className="mb-4 border-b last:border-0 pb-2">
                                            <p className="text-xs text-red-500 font-bold">å…ƒ: {pt.original}</p>
                                            <p className="text-xs text-green-600 font-bold">ä¿®æ­£: {pt.corrected}</p>
                                            <p className="text-xs text-slate-500">{pt.explanation}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t flex gap-4">
                            <button onClick={()=>setScreen('script')} className="flex-1 py-3 bg-slate-200 rounded-xl font-bold text-slate-700">å¾©ç¿’</button>
                            <button onClick={goToHome} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">çµ‚äº†</button>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const ScenarioIcon = ({ icon: Icon, size, className }) => <Icon size={size} className={className} />;

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
