<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Wordloop - 無料単語帳</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #F8FAFC;
            --text-main: #475569;
            --accent: #258FAF;
            --shadow-light: #FFFFFF;
            --shadow-dark: #E6EFF5;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        .h-screen-safe {
            height: 100vh;
            height: 100dvh;
        }

        /* Neumorphism Utilities */
        .neu-flat {
            background: var(--bg-color);
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
            border-radius: 16px;
            border: none;
        }
        .neu-pressed {
            background: var(--bg-color);
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            border-radius: 12px;
        }
        .neu-btn {
            background: var(--bg-color);
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            border-radius: 12px;
            transition: transform 0.1s;
        }
        .neu-btn:active {
            box-shadow: inset 2px 2px 4px var(--shadow-dark), inset -2px -2px 4px var(--shadow-light);
            transform: scale(0.98);
        }
        .neu-input {
            background: var(--bg-color);
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            border-radius: 16px;
            outline: none;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Card Flip Fixed */
        .card-flip { perspective: 1000px; }
        .card-inner { 
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); 
            transform-style: preserve-3d; 
            position: relative; 
            width: 100%; 
            height: 100%; 
            transform-origin: center center;
        }
        .card-front, .card-back { 
            backface-visibility: hidden; 
            -webkit-backface-visibility: hidden; /* Safari fix */
            position: absolute; 
            width: 100%; 
            height: 100%; 
            top: 0; 
            left: 0;
        }
        .card-back { transform: rotateY(180deg); }
        .flipped .card-inner { transform: rotateY(180deg); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Firebase Config & Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyCqoqNq7N-x5Wr6TsJkyCU0J6o-Mj1Ir8g",
            authDomain: "conizm-01.firebaseapp.com",
            projectId: "conizm-01",
            storageBucket: "conizm-01.firebasestorage.app",
            messagingSenderId: "180210157068",
            appId: "1:180210157068:web:e03a373dd3f818cdee1029",
            measurementId: "G-YD40SF3F32"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const analytics = firebase.analytics();

        const { useState, useEffect, useRef } = React;

        // --- 2. Helper Functions ---
        const translateText = async (text, langPair = "en|ja") => {
            if (!text) return "";
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${langPair}`);
                const data = await res.json();
                let translated = data.responseData.translatedText;
                if (translated) {
                    translated = translated.replace(/&#x0D;/g, '').replace(/&quot;/g, '"').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>');
                }
                return translated;
            } catch (e) {
                console.warn("Translation failed", e);
                return text; 
            }
        };

        const isJapanese = (text) => /[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/.test(text);

        const getPartOfSpeechJa = (text) => {
            const map = {
                noun: "名詞", verb: "動詞", adjective: "形容詞", adverb: "副詞",
                pronoun: "代名詞", preposition: "前置詞", conjunction: "接続詞",
                interjection: "間投詞", article: "冠詞", determiner: "限定詞",
                "transitive verb": "他動詞", "intransitive verb": "自動詞",
                "suru verb": "スル動詞", "translation": "翻訳"
            };
            return text.split(/,\s*/).map(p => map[p.toLowerCase()] || p).join('・');
        };

        const fetchDictionaryData = async (term) => {
            try {
                let searchWord = term;
                let isJpSearch = isJapanese(term);
                if (isJpSearch) {
                    searchWord = await translateText(term, "ja|en");
                }
                const dictRes = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(searchWord)}`);
                const transRes = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(term)}&langpair=${isJpSearch ? "ja|en" : "en|ja"}`);
                
                if (!dictRes.ok && !transRes.ok) throw new Error("データなし");
                let primaryTrans = "";
                if (transRes.ok) {
                    const d = await transRes.json();
                    primaryTrans = d.responseData.translatedText.replace(/&#x0D;/g, '').replace(/&quot;/g, '"').replace(/&amp;/g, '&');
                }
                const meanings = [];
                let pronunciation = "";
                let synonyms = [];
                let audioUrl = ""; 

                if (dictRes.ok) {
                    const data = await dictRes.json();
                    const entry = data[0];
                    pronunciation = entry.phonetic || (entry.phonetics.find(p => p.text) ? entry.phonetics.find(p => p.text).text : "");
                    
                    const phoneticsWithAudio = entry.phonetics.find(p => p.audio && p.audio !== "");
                    if (phoneticsWithAudio) {
                        audioUrl = phoneticsWithAudio.audio;
                    }

                    synonyms = entry.meanings.flatMap(m => m.synonyms).slice(0,5);
                    for(const m of entry.meanings.slice(0,3)) {
                        const def = m.definitions[0];
                        const defJa = await translateText(def.definition, "en|ja");
                        const exEn = def.example || "";
                        const exJa = exEn ? await translateText(exEn, "en|ja") : "";
                        meanings.push({
                            partOfSpeech: m.partOfSpeech, 
                            definitionJa: defJa,
                            definitionEn: def.definition,
                            exampleEn: exEn,
                            exampleJa: exJa
                        });
                    }
                }
                if (meanings.length === 0) {
                    meanings.push({
                        partOfSpeech: "translation",
                        definitionJa: primaryTrans,
                        definitionEn: "",
                        exampleEn: "",
                        exampleJa: ""
                    });
                }
                return {
                    word: isJpSearch ? primaryTrans : searchWord,
                    pronunciation: pronunciation,
                    translation: primaryTrans,
                    meanings: meanings,
                    definition: meanings[0].definitionJa,
                    example: meanings[0].exampleEn,
                    synonyms: synonyms,
                    audioUrl: audioUrl, 
                    tips: "公開辞書/翻訳データを使用"
                };
            } catch (e) {
                console.error("Search Error:", e);
                throw e;
            }
        };

        const speak = (text, audioUrl = null) => {
            if (audioUrl) {
                new Audio(audioUrl).play().catch(e => console.error("Audio play failed", e));
                return;
            }
            if (!text) return;
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'en-US';
            const voices = window.speechSynthesis.getVoices();
            const enVoice = voices.find(v => v.lang === 'en-US') || voices.find(v => v.lang.startsWith('en'));
            if (enVoice) {
                ut.voice = enVoice;
            }
            window.speechSynthesis.speak(ut);
        };

        if (typeof window !== 'undefined' && window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }

        // --- 3. Components ---

        const Toast = ({ msg, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            return (
                <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 neu-flat px-6 py-3 rounded-full text-sm text-[#258FAF] font-bold z-[60] fade-in shadow-lg text-center whitespace-nowrap bg-white">
                    {msg}
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, onExport, onImport, user, onLogin, onLogout }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-100/90 z-[60] flex items-center justify-center p-4 backdrop-blur-sm fade-in">
                    <div className="neu-flat bg-[#F8FAFC] p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-lg font-bold text-[#258FAF]">設定</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><i className="fas fa-times"></i></button>
                        </div>
                        <div className="mb-6 border-b border-gray-200 pb-6">
                            <h3 className="text-sm font-bold text-gray-500 mb-3 flex items-center gap-2">
                                <i className="fas fa-cloud"></i> クラウド同期
                            </h3>
                            <div>
                                {user ? (
                                    <div className="bg-green-50 p-4 rounded-xl border border-green-100 text-center">
                                        <p className="text-sm text-green-700 font-bold mb-2">ログイン中</p>
                                        <p className="text-xs text-gray-500 mb-3">{user.email || user.uid}</p>
                                        <button onClick={onLogout} className="bg-white text-red-500 border border-red-200 px-4 py-2 rounded-lg text-xs font-bold shadow-sm">
                                            ログアウト
                                        </button>
                                        <p className="text-[10px] text-gray-400 mt-2">データは自動的にクラウドに保存されます</p>
                                    </div>
                                ) : (
                                    <div className="bg-white p-4 rounded-xl border border-gray-100 text-center">
                                        <p className="text-xs text-gray-500 mb-3">ログインしてデータをバックアップ・同期できます。</p>
                                        <button onClick={onLogin} className="w-full bg-white border border-gray-200 text-gray-700 font-bold p-3 rounded-xl shadow-sm flex items-center justify-center gap-2 hover:bg-gray-50">
                                            <svg className="w-5 h-5" viewBox="0 0 24 24">
                                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" />
                                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
                                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
                                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
                                            </svg>
                                            Googleでログイン
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div>
                            <h3 className="text-sm font-bold text-gray-500 mb-3">ローカルバックアップ</h3>
                            <div className="flex gap-3">
                                <button onClick={onExport} className="flex-1 neu-btn p-3 text-xs font-bold text-gray-600 hover:text-[#258FAF] flex flex-col items-center gap-1">
                                    <i className="fas fa-file-export text-lg"></i>
                                    保存 (DL)
                                </button>
                                <label className="flex-1 neu-btn p-3 text-xs font-bold text-gray-600 hover:text-[#258FAF] flex flex-col items-center gap-1 cursor-pointer">
                                    <input type="file" accept=".json" className="hidden" onChange={onImport} />
                                    <i className="fas fa-file-import text-lg"></i>
                                    復元
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 4. Views ---

        const SearchView = ({ onSaveWord, savedWords, setToast, externalResult, setExternalResult }) => {
            const [term, setTerm] = useState('');
            const [loading, setLoading] = useState(false);
            const [loadingMsg, setLoadingMsg] = useState('');
            const resultRef = useRef(null);
            
            const handleSearch = async (e) => {
                e.preventDefault();
                if (!term.trim()) return;
                setLoading(true);
                setLoadingMsg(isJapanese(term) ? "英訳して検索中..." : "辞書を検索中...");
                setExternalResult(null);
                try {
                    const data = await fetchDictionaryData(term);
                    setExternalResult(data);
                } catch (err) {
                    setToast('検索できませんでした。スペルを確認してください。');
                }
                setLoading(false);
            };

            useEffect(() => {
                if (externalResult && resultRef.current) {
                    resultRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, [externalResult]);

            const currentData = externalResult;
            const isSaved = currentData && savedWords.some(w => w.word === currentData.word);

            return (
                <div className="fade-in">
                    <div className="mb-8 mt-2">
                        <form onSubmit={handleSearch} className="relative">
                            <input 
                                type="text" 
                                value={term}
                                onChange={(e) => setTerm(e.target.value)}
                                className="neu-input w-full p-4 pl-12 text-lg text-[#258FAF] placeholder-gray-400" 
                                placeholder="単語を入力 (例: apple / リンゴ)" 
                            />
                            <i className="fas fa-search absolute left-5 top-5 text-gray-400"></i>
                            <button type="submit" className="absolute right-2 top-2 bg-[#258FAF] text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-md active:scale-95 transition-transform">
                                <i className="fas fa-arrow-right"></i>
                            </button>
                        </form>
                        <p className="text-[10px] text-gray-400 text-center mt-3 tracking-widest">JAPANESE ⇄ ENGLISH DICTIONARY</p>
                    </div>

                    {loading && (
                        <div className="flex flex-col items-center justify-center py-12">
                            <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-[#258FAF] mb-4"></div>
                            <p className="text-sm text-gray-500 animate-pulse">{loadingMsg}</p>
                        </div>
                    )}

                    {!loading && !currentData && (
                        <div className="text-center py-20 opacity-40 select-none">
                            <div className="neu-flat w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-6 text-[#258FAF]">
                                <i className="fas fa-book text-4xl"></i>
                            </div>
                            <p className="font-bold text-gray-500">単語を入力して検索</p>
                            <p className="text-xs text-gray-400 mt-2">日本語・英語 どちらでも検索できます</p>
                        </div>
                    )}

                    {currentData && (
                        <div ref={resultRef} className="neu-flat p-5 md:p-6 mb-8 fade-in">
                            <div className="flex justify-between items-start mb-6 border-b border-gray-100 pb-4">
                                <div>
                                    {/* レスポンシブ文字サイズ調整 */}
                                    <h2 className="text-3xl md:text-4xl font-bold text-[#258FAF] break-all mb-1">{currentData.word}</h2>
                                    
                                    {currentData.pronunciation && (
                                        <div className="mb-2">
                                            <span className="text-xs md:text-sm text-gray-500 font-mono bg-gray-100 px-2 py-0.5 rounded">
                                                {currentData.pronunciation}
                                            </span>
                                        </div>
                                    )}
                                    
                                    <p className="text-lg md:text-xl font-bold text-gray-700 mt-3">{currentData.translation}</p>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => speak(currentData.word, currentData.audioUrl)} className="neu-btn w-10 h-10 flex items-center justify-center rounded-full text-[#258FAF]">
                                        <i className="fas fa-volume-up"></i>
                                    </button>
                                    <button 
                                        onClick={() => onSaveWord(currentData)} 
                                        className={`neu-btn w-10 h-10 flex items-center justify-center rounded-full ${isSaved ? 'text-yellow-500 neu-pressed' : 'text-gray-400'}`}
                                    >
                                        <i className="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>

                            <div className="space-y-8">
                                {currentData.meanings && currentData.meanings.length > 0 ? (
                                    currentData.meanings.map((m, idx) => (
                                        <div key={idx} className="relative">
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="px-3 py-1 bg-slate-100 text-slate-600 text-xs font-bold rounded-md uppercase">
                                                    {m.partOfSpeech.toUpperCase()} <span className="text-slate-400 font-normal">({getPartOfSpeechJa(m.partOfSpeech)})</span>
                                                </span>
                                            </div>
                                            <div className="pl-2 border-l-2 border-[#258FAF]/30">
                                                <p className="text-gray-800 font-bold mb-1 leading-relaxed text-sm md:text-base">{m.definitionJa}</p>
                                                <p className="text-xs text-gray-400 mb-3">{m.definitionEn}</p>
                                                {m.exampleEn && (
                                                    <div className="neu-pressed p-3 rounded-lg mt-2 bg-[#F1F5F9]">
                                                        <p className="text-sm text-[#258FAF] italic mb-1">"{m.exampleEn}"</p>
                                                        {m.exampleJa && (
                                                            <p className="text-xs text-gray-500">{m.exampleJa}</p>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center text-gray-400 text-sm">
                                        詳細な定義はありません。<br/>
                                        <span className="text-xs">翻訳: {currentData.translation}</span>
                                    </div>
                                )}

                                {currentData.synonyms && currentData.synonyms.length > 0 && (
                                    <div className="pt-4 border-t border-gray-100">
                                        <span className="text-xs font-bold text-gray-400 block mb-2">類義語 (Synonyms)</span>
                                        <div className="flex flex-wrap gap-2">
                                            {currentData.synonyms.slice(0,8).map((syn, i) => (
                                                <span key={i} className="neu-pressed px-3 py-1 text-xs text-gray-500 rounded-lg">{syn}</span>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="mt-6 text-center border-t border-gray-100 pt-4">
                                <p className="text-[10px] text-gray-300">
                                    Data sources: <a href="https://dictionaryapi.dev/" target="_blank" className="hover:text-gray-400">Free Dictionary API</a> & <a href="https://mymemory.translated.net/" target="_blank" className="hover:text-gray-400">MyMemory</a>
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ListView = ({ savedWords, onDeleteWord, onSelectWord }) => {
            if (savedWords.length === 0) {
                return (
                    <div className="text-center py-20 text-gray-400 fade-in">
                        <div className="neu-pressed w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i className="fas fa-book-open text-3xl"></i>
                        </div>
                        <p>保存された単語はありません</p>
                    </div>
                );
            }
            return (
                <div className="fade-in">
                    <h2 className="text-xl font-bold mb-6 text-[#258FAF] ml-2">単語帳 <span className="text-sm font-normal text-gray-500 ml-2">({savedWords.length})</span></h2>
                    <div className="space-y-4">
                        {savedWords.map((item, idx) => (
                            <div key={idx} onClick={() => onSelectWord(item)} className="neu-flat p-4 flex justify-between items-center cursor-pointer active:scale-[0.99] transition">
                                <div className="overflow-hidden">
                                    <div className="font-bold text-[#258FAF] text-lg">{item.word}</div>
                                    <div className="text-sm text-gray-600 font-bold">{item.translation}</div>
                                </div>
                                <button 
                                    className="neu-btn w-10 h-10 flex items-center justify-center rounded-full text-gray-400 hover:text-red-400 ml-2 shrink-0 relative z-10" 
                                    onClick={(e) => { e.stopPropagation(); onDeleteWord(item.word); }}
                                >
                                    <i className="fas fa-trash"></i>
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ReviewView = ({ savedWords, onFinish }) => {
            const [isStarted, setIsStarted] = useState(false);
            const [queue, setQueue] = useState([]);
            const [index, setIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);

            const startReview = () => {
                if (savedWords.length === 0) return alert('単語帳が空です');
                const shuffled = [...savedWords].sort(() => Math.random() - 0.5);
                setQueue(shuffled);
                setIndex(0);
                setIsFlipped(false);
                setIsStarted(true);
            };

            const handleNext = (e) => {
                if (e) e.stopPropagation();
                if (index >= queue.length - 1) {
                    alert('復習完了！お疲れ様でした。');
                    onFinish();
                } else {
                    setIsFlipped(false);
                    setIndex(prev => prev + 1);
                }
            };

            const toggleFlip = () => {
                if (!isFlipped) {
                    speak(queue[index].word, queue[index].audioUrl);
                }
                setIsFlipped(!isFlipped);
            };

            if (!isStarted) {
                return (
                    <div className="h-full flex flex-col justify-center items-center text-center fade-in">
                        <div className="neu-flat w-40 h-40 rounded-full flex items-center justify-center mb-8 text-[#258FAF]">
                            <i className="fas fa-graduation-cap text-6xl"></i>
                        </div>
                        <h2 className="text-2xl font-bold mb-2 text-[#258FAF]">Review Mode</h2>
                        <p className="text-gray-500 mb-10 text-sm">保存した単語からランダムに出題</p>
                        <button onClick={startReview} className="bg-[#258FAF] text-white px-10 py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">
                            テストを開始
                        </button>
                    </div>
                );
            }

            const currentCard = queue[index];
            let exampleEn = currentCard.example;
            if(currentCard.meanings && currentCard.meanings.length > 0 && currentCard.meanings[0].exampleEn) {
                exampleEn = currentCard.meanings[0].exampleEn;
            }
            const maskedExample = exampleEn && exampleEn !== "No example available." ? exampleEn.replace(new RegExp(currentCard.word, 'gi'), '_______') : "ヒントはありません";

            return (
                <div className="h-full flex flex-col items-center justify-center pb-4 relative fade-in">
                    <div className={`w-full max-w-sm h-[420px] card-flip cursor-pointer ${isFlipped ? 'flipped' : ''}`} onClick={toggleFlip}>
                        <div className="card-inner">
                            <div className="card-front neu-flat flex flex-col items-center justify-center p-8 text-center bg-[#F8FAFC] relative">
                                {/* スピーカーボタン位置調整: mt-6 を mt-2 にし、mb-6 を追加して単語との距離を確保 */}
                                <button 
                                    onClick={(e) => { e.stopPropagation(); speak(currentCard.word, currentCard.audioUrl); }} 
                                    className="neu-btn w-12 h-12 flex items-center justify-center rounded-full text-[#258FAF] mt-2 mb-6"
                                >
                                    <i className="fas fa-volume-up"></i>
                                </button>

                                <span className="absolute top-6 left-6 text-xs font-bold text-gray-400">QUESTION</span>
                                <h2 className="text-4xl font-bold text-[#258FAF] mb-8 break-all">{currentCard.word}</h2>
                                <div className="neu-pressed w-full p-4 rounded-xl">
                                    <p className="text-[10px] text-gray-400 mb-1">HINT</p>
                                    <p className="text-sm text-gray-600 italic">"{maskedExample}"</p>
                                </div>
                                <p className="absolute bottom-6 text-xs text-gray-400 opacity-60">タップして答えを表示</p>
                            </div>
                            <div className="card-back neu-flat flex flex-col items-center justify-center p-8 text-center bg-gradient-to-b from-[#F8FAFC] to-white">
                                <span className="absolute top-6 left-6 text-xs font-bold text-[#258FAF]">ANSWER</span>
                                <h3 className="text-2xl font-bold text-gray-700 mb-4">{currentCard.translation}</h3>
                                <div className="w-full overflow-y-auto max-h-32 text-sm text-gray-500 mb-4 px-4 space-y-2">
                                    {currentCard.meanings && currentCard.meanings.length > 0 
                                        ? currentCard.meanings.map((m, i) => (
                                            <p key={i}><span className="font-bold">{m.partOfSpeech} ({getPartOfSpeechJa(m.partOfSpeech)}):</span> {m.definitionJa}</p>
                                        ))
                                        : <p>{currentCard.definition}</p>
                                    }
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); speak(currentCard.word, currentCard.audioUrl); }} className="neu-btn w-12 h-12 flex items-center justify-center rounded-full mt-2 text-[#258FAF]">
                                    <i className="fas fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div className="w-full max-w-sm mt-8">
                        <button onClick={handleNext} className="w-full bg-[#258FAF] text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                            次の単語へ <i className="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            );
        };

        // --- 5. Main App ---
        const App = () => {
            const [tab, setTab] = useState('search');
            const [savedWords, setSavedWords] = useState(JSON.parse(localStorage.getItem('aitan_words')) || []);
            const [toastMsg, setToastMsg] = useState(null);
            const [searchResult, setSearchResult] = useState(null);
            const [searchViewKey, setSearchViewKey] = useState(0);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            
            const [user, setUser] = useState(null);

            useEffect(() => {
                if (auth) {
                    auth.onAuthStateChanged(async (u) => {
                        setUser(u);
                        if (u) {
                            showToast('ログインしました');
                            try {
                                const doc = await db.collection('users').doc(u.uid).get();
                                if (doc.exists) {
                                    const cloudWords = doc.data().words || [];
                                    setSavedWords(prev => {
                                        const combined = [...cloudWords, ...prev];
                                        const unique = Array.from(new Map(combined.map(item => [item.word, item])).values());
                                        return unique;
                                    });
                                    showToast('データを同期しました');
                                }
                            } catch (err) {
                                console.error("Sync Error:", err);
                            }
                        }
                    });
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('aitan_words', JSON.stringify(savedWords));
                if (user && db) {
                    db.collection('users').doc(user.uid).set({
                        words: savedWords,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true }).catch(e => console.error("Cloud Save Error", e));
                }
            }, [savedWords, user]);

            const showToast = (msg) => {
                setToastMsg(msg);
            };

            const handleLogin = () => {
                if (!auth) return;
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(e => alert(`ログインエラー: ${e.message}`));
            };

            const handleLogout = () => {
                auth.signOut().then(() => {
                    showToast('ログアウトしました');
                    setUser(null);
                });
            };

            const handleSaveWord = (wordData) => {
                const exists = savedWords.some(w => w.word === wordData.word);
                if (exists) {
                    setSavedWords(prev => prev.filter(w => w.word !== wordData.word));
                    showToast('削除しました');
                } else {
                    setSavedWords(prev => [wordData, ...prev]);
                    showToast('保存しました');
                }
            };

            const handleDeleteWord = (word) => {
                setTimeout(() => {
                    if(confirm(`「${word}」を削除しますか？`)) {
                        setSavedWords(prev => prev.filter(w => w.word !== word));
                    }
                }, 10);
            };

            const handleListClick = (wordData) => {
                setSearchResult(wordData);
                setTab('search');
            };
            
            const resetToHome = () => {
                setTab('search');
                setSearchResult(null);
                setSearchViewKey(prev => prev + 1); 
            };

            const handleExport = () => {
                const dataStr = JSON.stringify(savedWords, null, 2);
                const blob = new Blob([dataStr], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `tangoop_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('バックアップを保存しました');
            };

            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            if(confirm('現在のデータを上書きしますか？\n（既存の単語帳は消え、ファイルの内容になります）')) {
                                setSavedWords(imported);
                                showToast('データを復元しました');
                                setIsSettingsOpen(false);
                            }
                        } else {
                            alert('無効なファイル形式です');
                        }
                    } catch (error) {
                        alert('読み込みに失敗しました');
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="h-screen-safe flex flex-col overflow-hidden">
                    <header 
                        className="p-4 z-50 flex justify-between items-center h-16 neu-flat mx-4 mt-4 mb-2 relative cursor-pointer hover:opacity-80 transition-opacity"
                    >
                        <div className="flex-1" onClick={resetToHome}>
                            <h1 className="text-xl font-bold tracking-tight text-[#258FAF] text-center">Wordloop</h1>
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); setIsSettingsOpen(true); }} className="absolute right-4 text-gray-400 hover:text-[#258FAF]">
                            <i className="fas fa-cog"></i>
                        </button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar relative z-0">
                        {tab === 'search' && (
                            <SearchView 
                                key={searchViewKey} 
                                savedWords={savedWords} 
                                onSaveWord={handleSaveWord} 
                                setToast={showToast}
                                externalResult={searchResult}
                                setExternalResult={setSearchResult}
                            />
                        )}
                        {tab === 'list' && (
                            <ListView 
                                savedWords={savedWords} 
                                onDeleteWord={handleDeleteWord} 
                                onSelectWord={handleListClick}
                            />
                        )}
                        {tab === 'review' && (
                            <ReviewView 
                                savedWords={savedWords} 
                                onFinish={() => setTab('search')}
                            />
                        )}
                    </main>

                    <SettingsModal 
                        isOpen={isSettingsOpen}
                        onClose={() => setIsSettingsOpen(false)}
                        onExport={handleExport}
                        onImport={handleImport}
                        user={user}
                        onLogin={handleLogin}
                        onLogout={handleLogout}
                    />

                    {/* ナビゲーション: 固定配置 */}
                    <nav className="neu-flat mx-4 mb-4 h-20 flex justify-around items-center z-50 fixed bottom-0 left-0 right-0 bg-[#F8FAFC]">
                        <button onClick={() => setTab('search')} className={`nav-btn flex flex-col items-center w-1/3 ${tab === 'search' ? 'tab-active' : 'tab-inactive'}`}>
                            <div className={`w-10 h-10 flex items-center justify-center rounded-xl mb-1 transition-all ${tab === 'search' ? 'neu-pressed' : ''}`}>
                                <i className="fas fa-search text-lg"></i>
                            </div>
                            <span className="text-[10px] font-bold">検索</span>
                        </button>
                        <button onClick={() => setTab('review')} className={`nav-btn flex flex-col items-center w-1/3 ${tab === 'review' ? 'tab-active' : 'tab-inactive'}`}>
                            <div className={`w-10 h-10 flex items-center justify-center rounded-xl mb-1 transition-all ${tab === 'review' ? 'neu-pressed' : ''}`}>
                                <i className="fas fa-brain text-lg"></i>
                            </div>
                            <span className="text-[10px] font-bold">復習</span>
                        </button>
                        <button onClick={() => setTab('list')} className={`nav-btn flex flex-col items-center w-1/3 ${tab === 'list' ? 'tab-active' : 'tab-inactive'}`}>
                            <div className={`w-10 h-10 flex items-center justify-center rounded-xl mb-1 transition-all ${tab === 'list' ? 'neu-pressed' : ''}`}>
                                <i className="fas fa-book text-lg"></i>
                            </div>
                            <span className="text-[10px] font-bold">単語帳</span>
                        </button>
                    </nav>

                    {toastMsg && <Toast msg={toastMsg} onClose={() => setToastMsg(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
