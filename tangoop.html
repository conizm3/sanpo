<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TANGOOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 配色 */
            --bg-color: #F8FAFC; 
            --text-main: #475569;
            --text-light: #94A3B8;
            
            /* ニューモーフィズム用の影 */
            --shadow-light: #FFFFFF;
            --shadow-dark: #E2E8F0;
            
            --accent: #258FAF;
        }

        body { 
            font-family: 'Noto Sans JP', 'Helvetica Neue', Arial, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: var(--bg-color);
            color: var(--text-main);
        }

        /* Neumorphism Utilities */
        .neu-flat {
            background: var(--bg-color);
            box-shadow: 4px 4px 10px var(--shadow-dark), 
                       -4px -4px 10px var(--shadow-light);
            border: 1px solid rgba(255,255,255,0.6);
        }

        .neu-pressed {
            background: var(--bg-color);
            box-shadow: inset 3px 3px 6px var(--shadow-dark), 
                       inset -3px -3px 6px var(--shadow-light);
            border: 1px solid rgba(255,255,255,0.0);
        }

        .neu-btn {
            background: var(--bg-color);
            box-shadow: 4px 4px 8px var(--shadow-dark), 
                       -4px -4px 8px var(--shadow-light);
            transition: all 0.2s ease;
            color: var(--accent);
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.5);
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .neu-btn:active, .neu-btn.active {
            box-shadow: inset 2px 2px 4px var(--shadow-dark), 
                       inset -2px -2px 4px var(--shadow-light);
            transform: translateY(1px);
        }

        .neu-btn-primary {
            background: var(--accent);
            color: white;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            box-shadow: 4px 4px 10px var(--shadow-dark), 
                       -4px -4px 10px var(--shadow-light);
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .neu-btn-primary:active {
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
            transform: translateY(1px);
        }
        .neu-btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .neu-input {
            background: var(--bg-color);
            box-shadow: inset 3px 3px 6px var(--shadow-dark), 
                       inset -3px -3px 6px var(--shadow-light);
            border: none;
            outline: none;
        }

        /* Animations */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .fade-in-anim { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .loader { border: 3px solid #E2E8F0; border-radius: 50%; border-top: 3px solid var(--accent); width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Card Flip */
        .card-flip { perspective: 1000px; }
        .card-inner { transition: transform 0.6s; transform-style: preserve-3d; }
        .card-front, .card-back { backface-visibility: hidden; }
        .card-back { transform: rotateY(180deg); }
        .flipped { transform: rotateY(180deg); }

        .tab-active { color: var(--accent); }
        .tab-inactive { color: var(--text-light); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="p-4 z-20 flex justify-between items-center h-16 neu-flat mx-4 mt-4 rounded-2xl mb-2 relative">
        <h1 class="text-xl font-bold tracking-tight text-[#258FAF]">TANGOOP</h1>
        <button onclick="window.openKeyModal()" class="text-xs text-gray-400 hover:text-blue-500 flex items-center gap-1 px-4 py-2 rounded-lg transition-colors cursor-pointer neu-btn border-none shadow-none active:shadow-inner">
            <i class="fas fa-key"></i> <span>Key設定</span>
        </button>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 pb-24 relative scroll-smooth no-scrollbar">
        
        <!-- API Key Modal (Simplified) -->
        <div id="apiKeyModal" class="fixed inset-0 bg-[#F8FAFC] bg-opacity-95 z-50 flex items-center justify-center hidden backdrop-blur-sm">
            <div class="neu-flat p-8 rounded-2xl w-11/12 max-w-md">
                <h2 class="text-lg font-bold mb-2 text-[#258FAF]">APIキー設定</h2>
                <p class="text-sm text-gray-500 mb-6">Google AI StudioのAPIキーを入力してください。</p>
                <input type="password" id="apiKeyInput" placeholder="API Key (AIza...)" class="w-full neu-input p-4 rounded-xl mb-6 text-gray-600 tracking-wider font-mono">
                <button onclick="window.saveApiKey()" class="w-full neu-btn-primary p-4 rounded-xl font-bold">保存して閉じる</button>
                <div class="text-xs text-center mt-6 space-y-2">
                    <p class="text-gray-400"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-[#258FAF]">Google AI Studioで取得</a></p>
                </div>
            </div>
        </div>

        <!-- VIEW: SEARCH (Home) -->
        <div id="view-search" class="fade-in-anim">
            <div class="mb-8 mt-2">
                <!-- Search Form: Prevent default submit to stop reload -->
                <form onsubmit="event.preventDefault(); window.handleSearch();" class="relative">
                    <input type="text" id="searchInput" placeholder="単語を入力 (例: Serendipity)" 
                           class="w-full neu-input p-4 pl-12 rounded-2xl text-lg transition-all text-[#258FAF] placeholder-gray-400"
                           autocomplete="off">
                    <i class="fas fa-search absolute left-5 top-5 text-gray-400 pointer-events-none"></i>
                    
                    <button type="submit" id="triggerSearchBtn" class="absolute right-2 top-2 neu-btn-primary w-12 h-12 rounded-xl flex items-center justify-center transition-transform active:scale-95 cursor-pointer">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </form>
                <div class="mt-3 text-center">
                    <p class="text-[10px] text-gray-400 tracking-widest">ENGLISH ⇆ JAPANESE</p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading" class="hidden flex flex-col items-center justify-center py-10">
                <div class="loader mb-4"></div>
                <p class="text-sm text-gray-500 animate-pulse">AIが解析中...</p>
            </div>

            <!-- Search Result Card -->
            <div id="resultCard" class="hidden neu-flat rounded-3xl overflow-hidden p-6 relative mb-8">
                <!-- Actions -->
                <div class="absolute top-6 right-6 flex space-x-3">
                    <button onclick="window.playAudio()" class="neu-btn w-10 h-10 rounded-full flex items-center justify-center text-[#258FAF]">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button id="bookmarkBtn" onclick="window.toggleBookmark()" class="neu-btn w-10 h-10 rounded-full flex items-center justify-center text-gray-400">
                        <i class="fas fa-bookmark"></i>
                    </button>
                </div>

                <!-- Word Header -->
                <div class="mb-6 pr-20">
                    <h2 id="res-word" class="text-3xl font-bold text-[#258FAF] mb-1 break-words">Word</h2>
                    <p id="res-pronunciation" class="text-sm text-gray-500 font-mono tracking-wider">/pronunciation/</p>
                </div>

                <!-- Content Body -->
                <div class="space-y-6">
                    <!-- Definition -->
                    <div class="bg-gray-100 bg-opacity-50 rounded-xl p-3 border border-gray-100">
                        <span class="text-xs font-bold text-[#258FAF] opacity-70 mb-1 block">意味</span>
                        <p id="res-definition" class="text-lg font-bold text-gray-700 leading-relaxed">定義がここに表示されます。</p>
                    </div>

                    <!-- Example -->
                    <div class="neu-pressed p-4 rounded-xl relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-[#258FAF] opacity-50"></div>
                        <span class="text-[10px] font-bold text-gray-400 uppercase mb-1 block pl-2">Example</span>
                        <p id="res-example" class="text-gray-600 italic pl-2 leading-relaxed">"Example sentence goes here."</p>
                    </div>

                    <!-- Synonyms -->
                    <div>
                        <span class="text-xs font-bold text-gray-400 mb-2 block">類義語</span>
                        <div id="res-synonyms" class="flex flex-wrap gap-2">
                            <!-- Tags injected here -->
                        </div>
                    </div>

                    <!-- Usage Tips -->
                    <div class="pt-4 border-t border-gray-200 border-opacity-30">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-info-circle text-[#258FAF] mt-1 text-xs"></i>
                            <div>
                                <span class="text-xs font-bold text-[#258FAF]">MEMO</span>
                                <p id="res-tips" class="text-sm text-gray-500 mt-1 leading-relaxed">ここに使われ方のコツなどが表示されます。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Welcome Placeholder -->
            <div id="welcome-msg" class="text-center py-24 opacity-40 select-none pointer-events-none">
                <div class="neu-flat w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-6 text-[#258FAF]">
                    <i class="fas fa-search text-4xl"></i>
                </div>
                <p class="text-gray-500 font-bold">単語を入力して検索</p>
                <p class="text-xs text-gray-400 mt-2">AIがあなたの学習をサポートします</p>
            </div>
        </div>

        <!-- VIEW: LIST (Bookmarks) -->
        <div id="view-list" class="hidden">
            <h2 class="text-xl font-bold mb-6 text-[#258FAF] ml-2">単語帳 <span id="list-count" class="text-sm font-normal text-gray-500 ml-2">(0)</span></h2>
            <div id="vocab-list" class="space-y-4 pb-8">
                <!-- List items injected here -->
            </div>
            <div id="empty-list-msg" class="text-center py-20 text-gray-400 hidden">
                <div class="neu-pressed w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-book-open text-3xl text-gray-300"></i>
                </div>
                <p>保存された単語はありません</p>
            </div>
        </div>

        <!-- VIEW: REVIEW (Test) -->
        <div id="view-review" class="hidden h-full flex flex-col">
            <div id="review-setup" class="flex-1 flex flex-col items-center justify-center text-center">
                <div class="neu-flat w-40 h-40 rounded-full flex items-center justify-center mb-8 text-[#258FAF]">
                    <i class="fas fa-graduation-cap text-6xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-[#258FAF]">Review Mode</h2>
                <p class="text-gray-500 mb-10 text-sm">保存した単語からランダムに出題</p>
                <button onclick="window.startReview()" class="neu-btn-primary px-10 py-4 rounded-2xl font-bold shadow-lg w-full max-w-xs transition-transform transform active:scale-95">
                    テストを開始
                </button>
            </div>

            <div id="review-card-container" class="hidden flex-1 flex flex-col items-center justify-center relative pb-4">
                <!-- Flashcard -->
                <div id="flashcard" class="w-full max-w-sm h-[420px] relative card-flip cursor-pointer group" onclick="window.flipCard()">
                    <div id="flashcard-inner" class="card-inner w-full h-full relative">
                        <!-- Front -->
                        <div class="card-front absolute w-full h-full neu-flat rounded-3xl flex flex-col items-center justify-center p-8 text-center border-t border-white border-opacity-50">
                            <span class="absolute top-6 left-6 text-xs font-bold text-gray-400 tracking-widest">QUESTION</span>
                            <h2 id="test-word" class="text-4xl font-bold text-[#258FAF] mb-8 break-words w-full">Word</h2>
                            <div class="w-full bg-[#F8FAFC] rounded-xl p-4 neu-pressed">
                                <p class="text-[10px] text-gray-400 mb-2 uppercase tracking-wide">Hint</p>
                                <p id="test-example-hint" class="text-gray-600 italic text-sm font-medium">Example sentence...</p>
                            </div>
                            <p class="absolute bottom-6 text-xs text-gray-400 opacity-60">タップして答えを表示</p>
                        </div>
                        
                        <!-- Back -->
                        <div class="card-back absolute w-full h-full neu-flat rounded-3xl flex flex-col items-center justify-center p-8 text-center border-t border-white border-opacity-50 bg-gradient-to-b from-[#F8FAFC] to-[#F1F5F9]">
                            <span class="absolute top-6 left-6 text-xs font-bold text-[#258FAF] tracking-widest">ANSWER</span>
                            <div class="flex-1 flex flex-col justify-center w-full">
                                <h3 id="test-definition" class="text-xl font-bold text-gray-700 mb-4 leading-relaxed">Definition here</h3>
                                <div class="w-10 h-1 bg-[#258FAF] opacity-20 mx-auto mb-4 rounded-full"></div>
                                <p id="test-tips" class="text-sm text-gray-500">Usage tips...</p>
                            </div>
                            <button onclick="event.stopPropagation(); window.playAudio(currentTestWord)" class="neu-btn w-12 h-12 rounded-full flex items-center justify-center text-[#258FAF] mt-4 mb-2">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div id="review-controls" class="w-full max-w-sm flex space-x-4 mt-8 opacity-50 pointer-events-none transition-all duration-300">
                    <button onclick="window.nextCard(false)" class="flex-1 neu-btn py-4 rounded-2xl font-bold text-gray-500 hover:text-red-400">
                        <i class="fas fa-times mr-2"></i>忘れた
                    </button>
                    <button onclick="window.nextCard(true)" class="flex-1 neu-btn py-4 rounded-2xl font-bold text-gray-500 hover:text-[#258FAF]">
                        <i class="fas fa-check mr-2"></i>覚えた
                    </button>
                </div>
            </div>
            
            <div id="review-finish" class="hidden flex-1 flex flex-col items-center justify-center text-center">
                <div class="neu-flat w-32 h-32 rounded-full flex items-center justify-center mb-6 text-green-500">
                    <i class="fas fa-check text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-[#258FAF]">Finished!</h2>
                <p class="text-gray-500 mb-8">お疲れ様でした。</p>
                <button onclick="window.switchTab('search')" class="neu-btn px-8 py-3 rounded-xl text-[#258FAF] font-bold">ホームへ戻る</button>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="neu-flat h-20 rounded-t-3xl flex justify-around items-center z-20 pb-safe mx-0 absolute bottom-0 w-full">
        <button onclick="window.switchTab('search')" class="nav-btn flex flex-col items-center w-1/3 tab-active group cursor-pointer" data-target="search">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center mb-1 transition-all duration-200 group-[.tab-active]:neu-pressed">
                <i class="fas fa-search text-lg"></i>
            </div>
            <span class="text-[10px] font-bold">検索</span>
        </button>
        <button onclick="window.switchTab('review')" class="nav-btn flex flex-col items-center w-1/3 tab-inactive group cursor-pointer" data-target="review">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center mb-1 transition-all duration-200 group-[.tab-active]:neu-pressed">
                <i class="fas fa-brain text-lg"></i>
            </div>
            <span class="text-[10px] font-bold">復習</span>
        </button>
        <button onclick="window.switchTab('list')" class="nav-btn flex flex-col items-center w-1/3 tab-inactive group cursor-pointer" data-target="list">
            <div class="w-10 h-10 rounded-xl flex items-center justify-center mb-1 transition-all duration-200 group-[.tab-active]:neu-pressed">
                <i class="fas fa-book text-lg"></i>
            </div>
            <span class="text-[10px] font-bold">単語帳</span>
        </button>
    </nav>

    <script>
        // Global variables
        let apiKey = localStorage.getItem('aitan_api_key') || '';
        let savedWords = JSON.parse(localStorage.getItem('aitan_words')) || [];
        let currentResult = null;
        let testQueue = [];
        let currentTestIndex = 0;
        let currentTestWord = '';

        window.openKeyModal = function() {
            const input = document.getElementById('apiKeyInput');
            input.value = apiKey;
            document.getElementById('apiKeyModal').classList.remove('hidden');
        };

        window.saveApiKey = function() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if (input) {
                apiKey = input;
                localStorage.setItem('aitan_api_key', apiKey);
                document.getElementById('apiKeyModal').classList.add('hidden');
                window.showToast('設定完了');
            } else {
                alert('APIキーを入力してください');
            }
        };

        window.handleSearch = function() {
            const input = document.getElementById('searchInput');
            const term = input.value.trim();
            if (!term) {
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
                return;
            }
            window.searchWord(term);
        };

        window.onload = function() {
            if(!apiKey) document.getElementById('apiKeyModal').classList.remove('hidden');
            window.updateListCount();
        };

        // 頑丈なJSON抽出関数: 余計なテキストがあっても中括弧の間だけを抜き取る
        function extractJSON(text) {
            // 最初の { を探す
            const start = text.indexOf('{');
            // 最後の } を探す
            const end = text.lastIndexOf('}');
            
            if (start !== -1 && end !== -1 && end > start) {
                return text.substring(start, end + 1);
            }
            return text; // 見つからなければそのまま返す
        }

        window.searchWord = async function(term) {
            if (!apiKey) {
                window.openKeyModal();
                return;
            }

            // UI Update
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultCard').classList.add('hidden');
            document.getElementById('welcome-msg').classList.add('hidden');
            document.getElementById('searchInput').blur();
            document.getElementById('triggerSearchBtn').disabled = true;

            const prompt = `
            You are an expert language dictionary AI.
            User input: "${term}"
            Task: Provide a structured JSON response.
            Response MUST be valid JSON. Do not use markdown code blocks.
            JSON Structure:
            {
                "word": "The main word",
                "pronunciation": "IPA",
                "definition": "Definition in Japanese",
                "example": "Simple example sentence",
                "synonyms": ["synonym1", "synonym2"],
                "tips": "Usage tip in Japanese"
            }
            `;

            // 安定性の高い gemini-1.5-flash を優先使用
            // 失敗したら gemini-pro を試すシンプルな構成
            const models = ['gemini-1.5-flash', 'gemini-pro'];
            let success = false;
            let lastError = null;

            for (const model of models) {
                try {
                    console.log(`Trying model: ${model}`);
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                         // 明確なAPIキーエラーの場合は即終了
                         if (response.status === 400 && (data.error?.message?.includes('API key') || data.error?.status === 'INVALID_ARGUMENT')) {
                             throw new Error("API_KEY_INVALID");
                         }
                         throw new Error(data.error?.message || `HTTP Error: ${response.status}`);
                    }

                    if (!data.candidates || !data.candidates[0].content) throw new Error('EMPTY_RESPONSE');

                    let text = data.candidates[0].content.parts[0].text;
                    
                    // JSON抽出の強化
                    const jsonStr = extractJSON(text);
                    
                    try {
                        const result = JSON.parse(jsonStr);
                        window.displayResult(result);
                        success = true;
                        break; // 成功したらループを抜ける
                    } catch(e) {
                        console.error("JSON Parse Error", e);
                        throw new Error("INVALID_JSON_FORMAT");
                    }

                } catch (e) {
                    console.warn(`Model ${model} failed:`, e);
                    lastError = e;
                    if (e.message === "API_KEY_INVALID") break; 
                }
            }

            if (!success) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('welcome-msg').classList.remove('hidden');
                
                let msg = lastError ? lastError.message : "Unknown error";
                if (msg === "API_KEY_INVALID" || msg.includes('API key')) {
                     alert('APIキーが無効です。正しいキーを確認してください。');
                     window.openKeyModal();
                } else if (msg === "INVALID_JSON_FORMAT") {
                    alert('AIからの応答形式が不正でした。もう一度試してみてください。');
                } else {
                    alert(`検索できませんでした。\nエラー: ${msg}`);
                }
            }
            
            document.getElementById('triggerSearchBtn').disabled = false;
        };

        window.displayResult = function(data) {
            currentResult = data;
            document.getElementById('res-word').textContent = data.word;
            document.getElementById('res-pronunciation').textContent = data.pronunciation || '';
            document.getElementById('res-definition').textContent = data.definition;
            document.getElementById('res-example').textContent = `"${data.example}"`;
            document.getElementById('res-tips').textContent = data.tips;

            const synContainer = document.getElementById('res-synonyms');
            synContainer.innerHTML = '';
            
            const synonyms = Array.isArray(data.synonyms) ? data.synonyms : [];
            synonyms.slice(0, 3).forEach(syn => {
                const span = document.createElement('span');
                span.className = 'neu-pressed px-3 py-1 rounded-lg text-xs text-gray-500';
                span.textContent = syn;
                synContainer.appendChild(span);
            });

            window.updateBookmarkBtn();
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('welcome-msg').classList.add('hidden');
            const card = document.getElementById('resultCard');
            
            card.classList.remove('hidden');
            // アニメーションクラスを再適用するために一度削除
            card.classList.remove('fade-in-anim');
            void card.offsetWidth; // Reflow hack
            card.classList.add('fade-in-anim');
            
            setTimeout(() => {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        };

        window.playAudio = function(word = null) {
            const target = word || (currentResult ? currentResult.word : '');
            if (!target) return;
            const ut = new SpeechSynthesisUtterance(target);
            ut.lang = 'en-US';
            window.speechSynthesis.speak(ut);
        };

        window.toggleBookmark = function() {
            if (!currentResult) return;
            const idx = savedWords.findIndex(w => w.word === currentResult.word);
            if (idx === -1) {
                savedWords.unshift({ ...currentResult, addedAt: Date.now() });
                window.showToast('保存しました');
            } else {
                savedWords.splice(idx, 1);
                window.showToast('削除しました');
            }
            localStorage.setItem('aitan_words', JSON.stringify(savedWords));
            window.updateBookmarkBtn();
            window.updateListCount();
        };

        window.updateBookmarkBtn = function() {
            const btn = document.getElementById('bookmarkBtn');
            if (!currentResult) return;
            const isSaved = savedWords.some(w => w.word === currentResult.word);
            if (isSaved) {
                btn.classList.add('text-yellow-400', 'neu-pressed');
                btn.classList.remove('text-gray-400');
            } else {
                btn.classList.remove('text-yellow-400', 'neu-pressed');
                btn.classList.add('text-gray-400');
            }
        };

        window.updateListCount = function() {
            document.getElementById('list-count').textContent = `(${savedWords.length})`;
        };

        window.switchTab = function(tab) {
            ['search', 'list', 'review'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                const btn = document.querySelector(`[data-target="${t}"]`);
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            const targetBtn = document.querySelector(`[data-target="${tab}"]`);
            targetBtn.classList.add('tab-active');
            targetBtn.classList.remove('tab-inactive');

            if (tab === 'list') window.renderList();
            if (tab === 'review') window.resetReview();
        };

        window.renderList = function() {
            const container = document.getElementById('vocab-list');
            container.innerHTML = '';
            if (savedWords.length === 0) {
                document.getElementById('empty-list-msg').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-list-msg').classList.add('hidden');

            savedWords.forEach(item => {
                const div = document.createElement('div');
                div.className = 'neu-flat p-5 rounded-2xl flex justify-between items-center cursor-pointer active:scale-[0.99] transition-transform';
                div.onclick = (e) => {
                    if(e.target.closest('.del-btn')) return;
                    window.switchTab('search');
                    window.displayResult(item);
                };
                div.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-lg text-[#258FAF]">${item.word}</div>
                        <div class="text-xs text-gray-500 truncate w-full mt-1">${item.definition}</div>
                    </div>
                    <button class="del-btn neu-btn w-10 h-10 rounded-full flex items-center justify-center text-gray-400 hover:text-red-400 flex-shrink-0 ml-4" onclick="window.deleteWord('${item.word}')">
                        <i class="fas fa-trash-alt text-sm pointer-events-none"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        };

        window.deleteWord = function(word) {
            if(!confirm(`「${word}」を削除しますか？`)) return;
            savedWords = savedWords.filter(w => w.word !== word);
            localStorage.setItem('aitan_words', JSON.stringify(savedWords));
            window.renderList();
            window.updateListCount();
        };

        window.resetReview = function() {
            document.getElementById('review-setup').classList.remove('hidden');
            document.getElementById('review-card-container').classList.add('hidden');
            document.getElementById('review-finish').classList.add('hidden');
        };

        window.startReview = function() {
            if (savedWords.length === 0) {
                alert('単語帳が空です。検索して保存してください。');
                return;
            }
            testQueue = [...savedWords].sort(() => Math.random() - 0.5);
            currentTestIndex = 0;
            document.getElementById('review-setup').classList.add('hidden');
            document.getElementById('review-card-container').classList.remove('hidden');
            window.showCard();
        };

        window.showCard = function() {
            if (currentTestIndex >= testQueue.length) {
                document.getElementById('review-card-container').classList.add('hidden');
                document.getElementById('review-finish').classList.remove('hidden');
                return;
            }
            const item = testQueue[currentTestIndex];
            currentTestWord = item.word;
            
            document.getElementById('flashcard-inner').classList.remove('flipped');
            document.getElementById('review-controls').classList.add('opacity-50', 'pointer-events-none');
            document.getElementById('review-controls').classList.remove('opacity-100', 'pointer-events-auto');

            document.getElementById('test-word').textContent = item.word;
            const masked = item.example.replace(new RegExp(item.word, 'gi'), '_______');
            document.getElementById('test-example-hint').textContent = `"${masked}"`;
            document.getElementById('test-definition').textContent = item.definition;
            document.getElementById('test-tips').textContent = item.tips;
        };

        window.flipCard = function() {
            const inner = document.getElementById('flashcard-inner');
            if (!inner.classList.contains('flipped')) {
                inner.classList.add('flipped');
                window.playAudio(currentTestWord);
                document.getElementById('review-controls').classList.remove('opacity-50', 'pointer-events-none');
                document.getElementById('review-controls').classList.add('opacity-100', 'pointer-events-auto');
            }
        };

        window.nextCard = function() {
            currentTestIndex++;
            window.showCard();
        };

        window.showToast = function(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 neu-flat px-6 py-3 rounded-full text-sm text-[#258FAF] font-bold z-50 fade-in shadow-lg';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
    </script>
</body>
</html>
